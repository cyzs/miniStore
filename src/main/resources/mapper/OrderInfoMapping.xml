<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.hxsp.dao.OrderInfoDao">
    <resultMap id="result" type="com.example.hxsp.bean.OrderInfo">
        <id column="id" property="id"/>
        <result column="order_id" property="orderId"/>
        <result column="uid" property="uid"/>
        <result column="real_name" property="realName"/>
        <result column="user_phone" property="userPhone"/>
        <result column="user_address" property="userAddress"/>
        <result column="freight_price" property="freightPrice"/>
        <result column="total_num" property="totalNum"/>
        <result column="total_price" property="totalPrice"/>
        <result column="total_postage" property="totalPostage"/>
        <result column="pay_price" property="payPrice"/>
        <result column="pay_postage" property="payPostage"/>
        <result column="deduction_price" property="deductionPrice"/>
        <result column="coupon_id" property="couponId"/>
        <result column="coupon_price" property="couponPrice"/>
        <result column="paid" property="paid"/>
        <result column="pay_time" property="payTime"/>
        <result column="pay_type" property="payType"/>
        <result column="status" property="status"/>
        <result column="refund_status" property="refundStatus"/>
        <result column="refund_reason_wap_img" property="refundReasonWaqImg"/>
        <result column="refund_reason_wap_explain" property="refundReasonWaqExplain"/>
        <result column="refund_reason_wap" property="refundReasonWaq"/>
        <result column="refund_reason" property="refundReason"/>
        <result column="refund_reason_time" property="refundReasonTime"/>
        <result column="refund_price" property="refundPrice"/>
        <result column="delivery_name" property="deliveryName"/>
        <result column="delivery_type" property="deliveryType"/>
        <result column="delivery_id" property="deliveryId"/>
        <result column="gain_integral" property="gainIntegral"/>
        <result column="use_integral" property="useIntegral"/>
        <result column="back_integral" property="backIntegral"/>
        <result column="mark" property="mark"/>
        <result column="is_del" property="isDel"/>
        <result column="unique" property="unique"/>
        <result column="remark" property="remark"/>
        <result column="combination_id" property="combinationId"/>
        <result column="pink_id" property="pinkId"/>
        <result column="cost" property="cost"/>
        <result column="seckill_id" property="seckillId"/>
        <result column="bargain_id" property="bargainId"/>
        <result column="is_channel" property="isChannel"/>
        <result column="is_remind" property="isRemind"/>
        <result column="is_system_del" property="isSystemDel"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="order_type" property="orderType"/>

        <collection property="orderProductList" select="ProductList" column="order_id"
                    ofType="com.example.hxsp.bean.OrderProduct" javaType="java.util.List" >

        </collection>
    </resultMap>

    <resultMap id="productResult" type="com.example.hxsp.bean.OrderProduct">
        <id column="id" property="id"/>
        <result column="order_id" property="orderId"/>
        <result column="product_id" property="productId"/>
        <result column="product_name" property="productName"/>
        <result column="image" property="image"/>
        <result column="price" property="price"/>
        <result column="cart_num" property="cartNum"/>
    </resultMap>

<!--    查询订单-->
    <select id="selOrder" resultType="com.example.hxsp.bean.OrderInfo" resultMap="result">
        select * from order_info
        <where>
        1=1

            <if test="uid!=null and uid!=''"> and uid=#{uid}  and is_del=0</if>
            <if test="uid==null and uid==''"> and is_system_del=0 </if>
            <if test="realName!=null and realName!=''"> and real_name like concat('%',#{realName},'%')</if>
            <if test="status!=null"> and status=#{status}</if>
            <if test="refundStatus!=null"> and refund_status=#{refundStatus}</if>
            <if test="paid!=null"> and paid=#{paid}</if>
             order by update_time desc
        </where>
    </select>

    <select id="ProductList" resultType="com.example.hxsp.bean.OrderProduct" resultMap="productResult">
        select * from order_product where order_id=#{orderId}
    </select>

<!--    根据订单号查询订单信息-->
    <select id="orderInfos" resultMap="result">
        select * from order_info where order_id=#{orderId}   order by update_time desc
    </select>

<!--添加订单-->
    <insert id="add" parameterType="com.example.hxsp.bean.OrderInfo">
        insert into order_info(order_id,uid,real_name,user_phone,user_address,freight_price,total_num,total_price,total_postage,
        pay_price,pay_postage,deduction_price,coupon_id,coupon_price,gain_integral,use_integral,order_type)  values (#{orderId},#{uid},#{realName},#{userPhone},#{userAddress},#{freightPrice},
        #{totalNum},#{totalPrice},#{totalPostage},#{payPrice},#{payPostage},#{deductionPrice},#{couponId},#{couponPrice},#{gainIntegral},#{useIntegral},#{orderType})
    </insert>


<!--    用户删除-->
    <update id="userDel" parameterType="com.example.hxsp.bean.OrderInfo">
        update order_info set is_del=1 where id=#{id}
    </update>

<!--    管理员删除-->
    <update id="adminDel" parameterType="com.example.hxsp.bean.OrderInfo">
        update order_info set is_system_del=1 where id=#{id}
    </update>

<!--成功支付-->
    <update id="sucPaid" parameterType="com.example.hxsp.bean.OrderInfo">
        update order_info set paid=1,pay_time=#{payTime} where order_id=#{orderId}
    </update>

<!--    发货-->
    <update id="deliverGoods" parameterType="com.example.hxsp.bean.OrderInfo">
        update order_info set delivery_name=#{deliveryName},delivery_type=#{deliveryType},delivery_id=#{deliveryId},status=1
        where order_id=#{orderId}
    </update>

<!--    申请退款-->
    <update id="refund" parameterType="com.example.hxsp.bean.OrderInfo">
        update order_info set refund_reason_wap_img=#{refundReasonWapImg},refund_reason_wap_explain=#{refundReasonWapExplain},
        refund_reason_wap=#{refundReasonWap},status=-1,refund_status=1 where order_id=#{orderId}
    </update>

<!--    同意退款-->
    <update id="agreeRefund" parameterType="com.example.hxsp.bean.OrderInfo">
        update order_info set refund_reason_time=#{refundReasonTime},refund_price=#{refundPrice},back_integral=#{backIntegral}
        ,status=-2,refund_status=2 where order_id=#{orderId}
    </update>

<!--    拒绝退款-->
    <update id="refusedRefund" parameterType="com.example.hxsp.bean.OrderInfo">
        update order_info set refund_reason=#{refundReason},status=-3,refund_status=0  where order_id=#{orderId}
    </update>

<!--    确认收货-->
    <update id="confirmTheGoods" parameterType="com.example.hxsp.bean.OrderInfo">
        update order_info set status=2 where order_id=#{orderId}
    </update>

</mapper>